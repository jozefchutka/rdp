<!DOCTYPE html>
<html>
<head>
</head>
<body>
<script type="text/javascript">
const uuid = "sender";
const peerConnectionConfig = {'iceServers': [{'urls': 'stun:stun.stunprotocol.org:3478'}, {'urls': 'stun:stun.l.google.com:19302'}]};
var localStream;
var peerConnection;
var serverConnection;

async function start() {
	localStream = await navigator.mediaDevices.getUserMedia({video:true, audio:false});
	serverConnection = new WebSocket('wss://' + window.location.hostname + ':8443');
	serverConnection.onmessage = onServerMessage;
	serverConnection.onopen = onServerOpen;
}

function onServerOpen() {
	peerConnection = new RTCPeerConnection(peerConnectionConfig);
	peerConnection.addTrack(localStream.getTracks()[0], localStream);
}

async function onServerMessage(message) {
	var signal = JSON.parse(message.data);
	if(signal.uuid == uuid) return;

	if(signal.sdp) {
		await peerConnection.setRemoteDescription(new RTCSessionDescription(signal.sdp))
		if(signal.sdp.type == 'offer')
			createdDescription(await peerConnection.createAnswer());
	} else if(signal.ice) {
		peerConnection.addIceCandidate(new RTCIceCandidate(signal.ice));
	}
}

async function createdDescription(description) {
	await peerConnection.setLocalDescription(description);
	serverConnection.send(JSON.stringify({'sdp': peerConnection.localDescription, 'uuid': uuid}));
}

start();
</script>
</body>
</html>
